<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/nav.css">
    <link rel="stylesheet" href="css/dashboards.css">
    <link rel="stylesheet" href="css/fonts/fonte.css">
     <link rel="icon" href="./assets/image-Photoroom (6) 1.png">
    <title>Dashboard | Jojoby</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body> 

    <nav id="menu-nav" class="menu-nav">
        <div class="logo-nav-lateral">
            <div class="icon-nav">
                <img src="./assets/image 18.png" alt="">
                <h2>Olá, <span id="nome"></span> </h2>

                <ul>
                    <li>
                        <a href="#">Centro de Dados</a>
                    </li>
                    <li>
                        <a href="quiz.html">Questionário</a>
                    </li>
                    <li>
                        <a href="personagem.html">Elenco Estelar</a>
                    </li>
                    <li>
                        <a href="perfil.html">Perfil</a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="sair-nav">
            <p>Sair</p>
        </div>
    </nav>

    <div id="mostrarGrafico" style="display:block">
        <section>
            <div class="container-favoritos">
                <h1> Veja os favoritos do Fandom! </h1>
            </div>
        </section>
        <section>
            <div class="container-kpi">
                <div class="quantidade-voto">
                    <h2> Quantidade de votos:</h2>
                    <span id="kpiTotal"></span>
                </div>

                <div class="personagem-favorito">
                    <h2>Personagem Favorito:</h2>
                    <span id="kpiPersonagem"></span>
                </div>

                <div class="temporada-favorita">
                    <h2>Parte Favorita:</h2>
                    <span id="kpiParte"></span>
                </div>
            </div>

            <div class="container-botao-votar">
                <h2>Vote no seu favorito</h2>
                <button onclick="votacao()"> Votar </button>
            </div>
        </section>
        <div class="container-grafico">
            <div class="linha">
                <h2>Personagens Favoritos</h2>
                <canvas id="linha"></canvas>
            </div>
            <div class="barra">
                <h2>Partes Favoritas</h2>
                <canvas id="barra"></canvas>
            </div>
        </div>
    </div>

    <div class="votacao" id="mostrarVotacao" style="display: none;">
         <section>
            <div class="container-favoritos">
                <h1> Vote no seu favorito! </h1>
            </div>
        </section>

        <section class="container-votacao">
          <div class="campo-votacao">
            <h3>Personagem</h3>
            <select id="selectPersonagem"></select>
          </div>
          
          <div class="campo-votacao">
          <h3>Parte</h3>
          <select id="selectParte"></select>
          <button onclick="registrarVoto()">Registrar voto</button>
          </div>
        </section>
    </div>

</body>

</html>


<script>
var dadosPersonagem = [
  { idpersonagem: 1, nome: "Jotaro", votos: 0 },
  { idpersonagem: 2, nome: "Joseph", votos: 0 },
  { idpersonagem: 3, nome: "Dio", votos: 0 }
];

var dadosPersonagemLocal = JSON.parse(JSON.stringify(dadosPersonagem));


var dadosParte = [
  { idtemporada: 1, parte: "Parte 1", votos: 0 },
  { idtemporada: 2, parte: "Parte 2", votos: 0 },
  { idtemporada: 3, parte: "Parte 3", votos: 0 }
];

const nomesDasPartes = {
  1: "Parte 1",
  2: "Parte 2",
  3: "Parte 3",
  4: "Parte 4",
  5: "Parte 5",
  6: "Parte 6"
};

var grafPersonagem;
var grafPartes;

var selectPersonagem = document.getElementById("selectPersonagem");
var selectParte = document.getElementById("selectParte");

// preencher selectPersonagem
for (var i = 0; i < dadosPersonagem.length; i++) {
  var option = document.createElement("option");
  option.value = dadosPersonagem[i].idpersonagem;
  option.textContent = dadosPersonagem[i].nome;
  selectPersonagem.appendChild(option);
}

// preencher selectParte
for (var i = 0; i < dadosParte.length; i++) {
  var option = document.createElement("option");
  option.value = dadosParte[i].idtemporada;
  option.textContent = dadosParte[i].parte;
  selectParte.appendChild(option);
}



function votacao() {
  document.getElementById("mostrarGrafico").style.display = "none";
  document.getElementById("mostrarVotacao").style.display = "block";
}


// CARREGAR VOTOS PERSONAGEM

function carregarVotos_personagem() {

    fetch("/selecao/votos-personagem")
        .then(res => res.json())
        .then(dados => {
           
            dadosPersonagem = dados;

            var labelsPersonagem = [];
            var votosPersonagem = [];

            for (var i = 0; i < dados.length; i++) {

                var idPersonagem = dados[i].fkpersonagem;
                var nomePersonagem = "Desconhecido";

                for (var j = 0; j < dadosPersonagemLocal.length; j++) {

                    if (dadosPersonagemLocal[j].idpersonagem == idPersonagem) {
                        nomePersonagem = dadosPersonagemLocal[j].nome;
                        break;
                    }
                }

                labelsPersonagem.push(nomePersonagem);
                votosPersonagem.push(dados[i].votos);
            }

            console.log("Labels personagens:", labelsPersonagem);
            console.log("Votos personagens:", votosPersonagem);

            criarGrafico_personagem(labelsPersonagem, votosPersonagem);

            atualizarKpiPersonagem();
        })
        .catch(erro => console.log("Erro ao carregar votos: ", erro));
}


function carregarVotos_parte() {
  fetch("/selecao/votos-parte")  
    .then(res => res.json())
    .then(dados => {
      console.log("RESPOSTA DA API /votos-parte:", dados);

      dadosParte = dados;

      var labelsPartes = [];
      var votosPartes = [];

      for (var i = 0; i < dados.length; i++) {
        labelsPartes.push(nomesDasPartes[dados[i].fktemporada]);
        votosPartes.push(dados[i].votos);
      }

      atualizarGraficoFavoritos(grafPartes, labelsPartes, votosPartes);
      atualizarTodasKPI();
    })
    .catch(erro => console.log("Erro ao carregar votos: ", erro));
}



function criarGrafico_personagem(labelsPersonagem, votosPersonagem) {
  grafPersonagem = new Chart(document.getElementById("linha").getContext("2d"), {
    type: 'bar',
    data: {
      labels: labelsPersonagem,
      datasets: [{
        label: 'Votos',
        data: votosPersonagem,
        backgroundColor: '#DBAF4F',
        borderColor: '#DBAF4F',
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { labels: { color: '#fff' } } },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' } }
      }
    }
  });
}

carregarVotos_personagem();
carregarVotos_parte();

// Criar gráfico vazio
grafPartes = new Chart(document.getElementById("barra").getContext("2d"), {
    type: 'bar',
    data: { labels: [], 
      datasets: [
        { data: [], 
          backgroundColor: '#4FDBAF', 
          borderColor: '#4FDBAF', 
          borderWidth: 1 }
      ] },
    options: { 
      plugins: 
      { legend: { 
        labels: { 
          color: '#fff' } 
        } }, scales: {
           x: { ticks: 
            { color: '#fff' } 
          }, y: { ticks: 
            { color: '#fff' } 
          } } 
        
        }
});


// REGISTRAR VOTO
function registrarVoto() {
  var fkusuario = sessionStorage.ID_USUARIO;
  var fkpersonagem = Number(document.getElementById("selectPersonagem").value);
  var fktemporada = Number(document.getElementById("selectParte").value);

  console.log("fkusuario:", fkusuario);
  console.log("fkpersonagem:", fkpersonagem);
  console.log("fktemporada:", fktemporada);

  for (var i = 0; i < dadosPersonagem.length; i++) {
    if (dadosPersonagem[i].idpersonagem == fkpersonagem) {
      dadosPersonagem[i].votos++;
    }
  }

  for (var i = 0; i < dadosParte.length; i++) {
    if (dadosParte[i].idtemporada == fktemporada) {
      dadosParte[i].votos++;
    }
  }

  var labelsPersonagem = [];
  var votosPersonagem = [];

  for (var i = 0; i < dadosPersonagem.length; i++) {
    labelsPersonagem.push(dadosPersonagem[i].nome);
    votosPersonagem.push(dadosPersonagem[i].votos);
  }

  var labelsPartes = [];
  var votosPartes = [];

  for (var i = 0; i < dadosParte.length; i++) {
    labelsPartes.push(nomesDasPartes[dadosParte[i].idtemporada]);
    votosPartes.push(dadosParte[i].votos);
  }

  atualizarGraficoFavoritos(grafPersonagem, labelsPersonagem, votosPersonagem);
  atualizarGraficoFavoritos(grafPartes, labelsPartes, votosPartes);

  atualizarTodasKPI();

  mostrarVotacao.style.display = "none";
  mostrarGrafico.style.display = "block";

  registrarVotacao(fkusuario, fkpersonagem, fktemporada);
}

// ATUALIZAR GRAFICO

function atualizarGraficoFavoritos(myChart, labelsNovos, dadosNovos) {
  myChart.data.labels = labelsNovos;
  myChart.data.datasets[0].data = dadosNovos;
  myChart.update();
}

// REGISTRANA API 

function registrarVotacao(fkusuario, fkpersonagem, fktemporada) {
  fetch("/selecao/selecionar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fkusuario: fkusuario,
        fkpersonagem: fkpersonagem,
        fktemporada: fktemporada
      })
    })
    .then(resposta => {
      if (resposta.ok) {
        console.log("Votação registrada com sucesso");
      } else {
        console.log("Falha ao registrar a votação");
      }
    })
    .catch(erro => console.error("Erro na API:", erro));
}
function atualizarTodasKPI() {
    fetch("/selecao/votos-personagem")
        .then(res => res.json())
        .then(personagens => {

            var total = 0;
            var personagemNome = "";
            var maior = -1;

            for (var i = 0; i < personagens.length; i++) {
                total += personagens[i].votos;

                if (personagens[i].votos > maior) {
                    maior = personagens[i].votos;

                    for (var j = 0; j < dadosPersonagemLocal.length; j++) {
                        if (dadosPersonagemLocal[j].idpersonagem == personagens[i].fkpersonagem) {
                            personagemNome = dadosPersonagemLocal[j].nome;
                            break;
                        }
                    }
                }
            }

            document.getElementById("kpiTotal").textContent = total;
            document.getElementById("kpiPersonagem").textContent = personagemNome;
        })
        .catch(err => console.log("Erro KPI personagem:", err));

    fetch("/selecao/votos-parte")
        .then(res => res.json())
        .then(partes => {

            var maior = -1;
            var parteNome = "";

            for (var i = 0; i < partes.length; i++) {
                var idTemp = partes[i].fktemporada;

                if (partes[i].votos > maior) {
                    maior = partes[i].votos;
                    parteNome = nomesDasPartes[idTemp];
                }
            }

            document.getElementById("kpiParte").textContent = parteNome;
        })
        .catch(err => console.log("Erro KPI parte:", err));
}


// PERFIL DO USUÁRIO

window.onload = () => {
  var usuarioID = sessionStorage.ID_USUARIO;

  fetch(`/perfil/exibir?id=${usuarioID}`)
    .then(res => res.json())
    .then(usuarioArray => {
      var usuario = usuarioArray[0];
      document.getElementById("nome").textContent = usuario.nome;
      document.getElementById("input_nome").textContent = usuario.nome;
      document.getElementById("input_email").textContent = usuario.email;
    })
    .catch(err => console.error("Erro ao carregar perfil: ", err));
};
</script>

